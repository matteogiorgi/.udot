#!/usr/bin/env bash


### Variables definition
########################

FILE="$*"
[[ -x "$(command -v nano)" ]] && NAMES="η-Nano\n"$NAMES
[[ -x "$(command -v kak)" ]] && NAMES="Kakoune\n"$NAMES
[[ -x "$(command -v vim)" ]] && NAMES="Vim-FZF\nVim-COC\n"$NAMES




### Functions definition
########################

if [ -f ~/.bash_functions ]; then
    . ~/.bash_functions
fi

function _vimcall () {
    VIMCALL="$1"
    if [[ "$(type -t $VIMCALL)" == function ]]; then
        $VIMCALL "${FILE}"
    elif [[ "$(type -t _vim)" == function ]]; then
        _vim "${FILE}"
    else
        vim "${FILE}"
    fi
}




### Greppers
############

echo "$*" | grep "\.ar\." && {
    _xhide xterm -e "${EDITOR:=vi}" "$*" &
    exit
}

echo "$1" | grep "\.sent$" && {
    _xhide sent "$1" &
    exit
}




### MIME-type opener (inode/directory not necessary)
####################################################

# check the relative mime-type here:
# https://www.iana.org/assignments/media-types/media-types.xhtml
case $(file --mime-type "${FILE}" -bL) in
    audio/*)
        clear &&
        _mpv "${FILE}"
        ;;
    video/*)
        _xshow "mpv --force-window --no-terminal --msg-level=all=no '${FILE}'"
        ;;
    application/pdf | application/postscript | application/djvu | image/vnd.djvu | application/epub+zip)
        _xshow "zathura '${FILE}'"
        ;;
     application/vnd.openxmlformats-officedocument.* | application/vnd.oasis.opendocument.* | application/vnd.ms-* | application/msword)
        _xshow "libreoffice '${FILE}'"
        ;;
     application/x-tar | application/zip | application/gzip)
        if [[ "${FILE##*.}" == "xopp" ]]; then
            _xshow "xournalpp '${FILE}'"
        elif [[ "${FILE##*.}" == "ora" ]]; then
            _xshow "mypaint '${FILE}'"
        else
            _xshow "xarchiver '${FILE}'"
        fi
        ;;
    image/*)
        _xshow "esxiv '${FILE}'"
        ;;
    *)
        if [[ ! -n $NAMES  || ! -f "/bin/fzf" ]]; then
            "${EDITOR:=vi}" "${FILE}"
            exit 0
        fi
        case $(printf "$NAMES" | fzf --prompt="Edit ${FILE##*/} with: " --height 100% --reverse --info=hidden --header-first) in
            Vim-FZF)
                _vimcall "_vimfzf" "${FILE}"
                ;;
            Vim-COC)
                _vimcall "_vimcoc" "${FILE}"
                ;;
            Kakoune)
                kak "${FILE}"
                ;;
            η-Nano)
                nano "${FILE}"
                ;;
            *)
                exit 1
        esac
esac
