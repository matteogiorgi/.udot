#!/usr/bin/env bash


# this function chose a random background inside the $BACKGROUNDS
# directory carefully excluding the one already in use
function _randombg () {
    [[ -z "$(ls -A $BACKGROUNDS 2>/dev/null)" ]] && exit 1
    while [[ $OLD_PIC == $NEW_PIC ]]; do
        OLD_PIC=$(awk '{if (NR==2) print $4}' $HOME/.fehbg); OLD_PIC=${OLD_PIC#"'"}; OLD_PIC=${OLD_PIC%"'"}
        NEW_PIC=$BACKGROUNDS/$(/bin/ls -1 $BACKGROUNDS | tail -$(($RANDOM %$(/bin/ls -1 | wc -l)+1)) | head -1)
    done
    feh --bg-fill $NEW_PIC
}

# this function cycle through the backgrounds inside the $BACKGROUNDS directory
# starting from the beginning each time a background is chosen differently
function _cyclebg () {
    [[ -z "$(ls -A $BACKGROUNDS 2>/dev/null)" ]] && exit 1
    ELEMS=$(/bin/ls -1 $BACKGROUNDS | wc -l)
    [[ -f ~/.fehbg ]] && INDEX=$(awk 'END{print $2}' $HOME/.fehbg) || INDEX="null"
    REGEX='^[0-9]+$'
    if [[ ! $INDEX =~ $REGEX ]]; then
        INDEX=$ELEMS
    elif [[ -n $PREV ]]; then
        [[ $INDEX -eq $ELEMS ]] && INDEX=1 || ((INDEX++))
    elif [[ -n $NEXT ]]; then
        [[ $INDEX == 1 ]] && INDEX=$ELEMS || ((INDEX--))
    fi
    feh --bg-fill $BACKGROUNDS/$(/bin/ls -1 $BACKGROUNDS | tail -$INDEX | head -1)
    echo "# $INDEX" >> $HOME/.fehbg
}




BACKGROUNDS="$HOME/Pictures/backgrounds"
case "$*" in
    --random)
        _randombg
        ;;
    --prev)
        PREV=1
        _cyclebg
        ;;
    --next)
        NEXT=1
        _cyclebg
        ;;
    "")
        xsetroot -gray
        [[ -f ~/.fehbg ]] && rm ~/.fehbg
        ;;
    *)
        exit 1
esac
xsetroot -cursor_name arrow
